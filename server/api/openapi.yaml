openapi: 3.0.3
info:
  title: AREA Server API
  version: 0.1.0
servers:
  - url: http://localhost:8080
paths:
  /about.json:
    get:
      summary: Describe server capabilities
      operationId: getAbout
      tags:
        - metadata
      responses:
        '200':
          description: About payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AboutResponse'
  /v1/users:
    post:
      summary: Register a new user
      operationId: registerUser
      tags:
        - auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterUserRequest'
      responses:
        '202':
          description: Registration accepted, verification email sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterUserResponse'
        '400':
          description: Invalid input
        '409':
          description: Email already registered
  /v1/auth/verify:
    post:
      summary: Verify email address and create a session
      operationId: verifyEmail
      tags:
        - auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyEmailRequest'
      responses:
        '200':
          description: Email verified and session issued
          headers:
            Set-Cookie:
              description: Authentication session cookie
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSessionResponse'
        '400':
          description: Invalid token
        '410':
          description: Token expired or already used
  /v1/auth/login:
    post:
      summary: Authenticate using email and password
      operationId: login
      tags:
        - auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Authentication succeeded
          headers:
            Set-Cookie:
              description: Authentication session cookie
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSessionResponse'
        '400':
          description: Invalid credentials
        '403':
          description: Account requires verification
  /v1/auth/logout:
    post:
      summary: Revoke the current session
      operationId: logout
      tags:
        - auth
      responses:
        '204':
          description: Logged out
  /v1/auth/me:
    get:
      summary: Retrieve the authenticated user profile
      operationId: getCurrentUser
      tags:
        - auth
      responses:
        '200':
          description: Current user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Session missing or expired
  /v1/oauth/{provider}/authorize:
    post:
      summary: Initiate OAuth authorization
      operationId: authorizeOAuth
      tags:
        - auth
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OAuthAuthorizationRequest'
      responses:
        '200':
          description: Authorization parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthAuthorizationResponse'
        '400':
          description: Invalid request
        '404':
          description: Provider not configured
        '501':
          description: OAuth not configured
  /v1/oauth/{provider}/exchange:
    post:
      summary: Exchange authorization code for session
      operationId: exchangeOAuth
      tags:
        - auth
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OAuthExchangeRequest'
      responses:
        '200':
          description: Authentication succeeded
          headers:
            Set-Cookie:
              description: Authentication session cookie
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSessionResponse'
        '400':
          description: Invalid payload
        '404':
          description: Provider not configured
        '501':
          description: OAuth not configured
        '502':
          description: Provider exchange failed
components:
  schemas:
    AboutResponse:
      type: object
      required: [client, server]
      properties:
        client:
          $ref: '#/components/schemas/AboutClient'
        server:
          $ref: '#/components/schemas/AboutServer'
    AboutClient:
      type: object
      required: [host]
      properties:
        host:
          type: string
          description: IP address of the client issuing the request
    AboutServer:
      type: object
      required: [current_time, services]
      properties:
        current_time:
          type: integer
          format: int64
          description: Unix epoch timestamp
        services:
          type: array
          description: Services supported by the server
          items:
            $ref: '#/components/schemas/Service'
    Service:
      type: object
      required: [name, actions, reactions]
      properties:
        name:
          type: string
        actions:
          type: array
          items:
            $ref: '#/components/schemas/Component'
        reactions:
          type: array
          items:
            $ref: '#/components/schemas/Component'
    Component:
      type: object
      required: [name, description]
      properties:
        name:
          type: string
        description:
          type: string
    RegisterUserRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
    RegisterUserResponse:
      type: object
      required: [expires_at]
      properties:
        expires_at:
          type: string
          format: date-time
    VerifyEmailRequest:
      type: object
      required: [token]
      properties:
        token:
          type: string
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
    OAuthAuthorizationRequest:
      type: object
      properties:
        redirect_uri:
          type: string
          format: uri
        scopes:
          type: array
          items:
            type: string
        state:
          type: string
        prompt:
          type: string
        use_pkce:
          type: boolean
          default: true
    OAuthAuthorizationResponse:
      type: object
      required: [authorization_url]
      properties:
        authorization_url:
          type: string
          format: uri
        state:
          type: string
        code_verifier:
          type: string
        code_challenge:
          type: string
        code_challenge_method:
          type: string
          enum: [plain, S256]
    OAuthExchangeRequest:
      type: object
      required: [code]
      properties:
        code:
          type: string
        redirect_uri:
          type: string
          format: uri
        code_verifier:
          type: string
        state:
          type: string
    AuthSessionResponse:
      type: object
      required: [user]
      properties:
        user:
          $ref: '#/components/schemas/User'
    UserResponse:
      type: object
      required: [user]
      properties:
        user:
          $ref: '#/components/schemas/User'
    User:
      type: object
      required: [id, email, status, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        last_login_at:
          type: string
          format: date-time
          nullable: true
