services:
  server:
    build: ./server
    ports: ["8080:8080"]
    environment:
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_URL: ${DATABASE_URL}
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      PASSWORD_PEPPER: ${PASSWORD_PEPPER}
      GOOGLE_OAUTH_CLIENT_ID: ${GOOGLE_OAUTH_CLIENT_ID}
      GOOGLE_OAUTH_CLIENT_SECRET: ${GOOGLE_OAUTH_CLIENT_SECRET}
      GITHUB_OAUTH_CLIENT_ID: ${GITHUB_OAUTH_CLIENT_ID}
      GITHUB_OAUTH_CLIENT_SECRET: ${GITHUB_OAUTH_CLIENT_SECRET}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8080/about.json",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  client_mobile:
    build:
      context: ./mobile
      dockerfile: Dockerfile
    volumes:
      - apkshare:/apkshare

  client_web:
    build:
      context: ./web
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
        API_PROXY_TARGET: ${API_PROXY_TARGET:-http://localhost:8080}
        CORS_ALLOWED_ORIGIN: ${CORS_ALLOWED_ORIGIN:-http://localhost:8081}
        NEXT_PUBLIC_API_MODE: ${NEXT_PUBLIC_API_MODE:-live}
    depends_on:
      - client_mobile
      - server
    ports: ["8081:8081"]
    volumes:
      - apkshare:/apkshare

volumes:
  apkshare:
