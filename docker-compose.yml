services:
  server:
    build: ./server
    ports: ["8080:8080"]
    depends_on:
      redis:
        condition: service_started
    environment:
      DATABASE_URL: ${DATABASE_URL}
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      PASSWORD_PEPPER: ${PASSWORD_PEPPER}
      IDENTITY_ENCRYPTION_KEY: ${IDENTITY_ENCRYPTION_KEY}
      GOOGLE_OAUTH_CLIENT_ID: ${GOOGLE_OAUTH_CLIENT_ID}
      GOOGLE_OAUTH_CLIENT_SECRET: ${GOOGLE_OAUTH_CLIENT_SECRET}
      GITHUB_OAUTH_CLIENT_ID: ${GITHUB_OAUTH_CLIENT_ID}
      GITHUB_OAUTH_CLIENT_SECRET: ${GITHUB_OAUTH_CLIENT_SECRET}
      GITLAB_OAUTH_CLIENT_ID: ${GITLAB_OAUTH_CLIENT_ID}
      GITLAB_OAUTH_CLIENT_SECRET: ${GITLAB_OAUTH_CLIENT_SECRET}
      DROPBOX_OAUTH_CLIENT_ID: ${DROPBOX_OAUTH_CLIENT_ID}
      DROPBOX_OAUTH_CLIENT_SECRET: ${DROPBOX_OAUTH_CLIENT_SECRET}
      SLACK_OAUTH_CLIENT_ID: ${SLACK_OAUTH_CLIENT_ID}
      SLACK_OAUTH_CLIENT_SECRET: ${SLACK_OAUTH_CLIENT_SECRET}
      MICROSOFT_OAUTH_CLIENT_ID: ${MICROSOFT_OAUTH_CLIENT_ID}
      MICROSOFT_OAUTH_CLIENT_SECRET: ${MICROSOFT_OAUTH_CLIENT_SECRET}
      ZOOM_OAUTH_CLIENT_ID: ${ZOOM_OAUTH_CLIENT_ID}
      ZOOM_OAUTH_CLIENT_SECRET: ${ZOOM_OAUTH_CLIENT_SECRET}
      LINEAR_OAUTH_CLIENT_ID: ${LINEAR_OAUTH_CLIENT_ID}
      LINEAR_OAUTH_CLIENT_SECRET: ${LINEAR_OAUTH_CLIENT_SECRET}
      SPOTIFY_OAUTH_CLIENT_ID: ${SPOTIFY_OAUTH_CLIENT_ID}
      SPOTIFY_OAUTH_CLIENT_SECRET: ${SPOTIFY_OAUTH_CLIENT_SECRET}
      NOTION_OAUTH_CLIENT_ID: ${NOTION_OAUTH_CLIENT_ID}
      NOTION_OAUTH_CLIENT_SECRET: ${NOTION_OAUTH_CLIENT_SECRET}
      REDDIT_OAUTH_CLIENT_ID: ${REDDIT_OAUTH_CLIENT_ID}
      REDDIT_OAUTH_CLIENT_SECRET: ${REDDIT_OAUTH_CLIENT_SECRET}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      AREA_QUEUE_REDIS_ADDR: ${AREA_QUEUE_REDIS_ADDR:-redis:6379}
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:8080/about.json",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  client_mobile:
    build:
      context: ./mobile
      dockerfile: Dockerfile
    volumes:
      - apkshare:/apkshare

  client_web:
    build:
      context: ./web
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-/v1}
        API_PROXY_TARGET: ${API_PROXY_TARGET:-http://server:8080/v1}
        CORS_ALLOWED_ORIGIN: ${CORS_ALLOWED_ORIGIN:-http://localhost:8081}
        NEXT_PUBLIC_API_MODE: ${NEXT_PUBLIC_API_MODE:-live}
    depends_on:
      - client_mobile
      - server
    ports: ["8081:8081"]
    volumes:
      - apkshare:/apkshare

volumes:
  apkshare:
